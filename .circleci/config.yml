version: 2.1
jobs:
  build:
    environment:
      - EARTHLY_VERSION: "v0.0.1"
      - EARTHLY_BUILDKITD_IMAGE: "earthly/buildkitd:v0.0.1"
    machine:
      image: ubuntu-1604:201903-01
      docker_layer_caching: true
    steps:
      - checkout
      - run: |
        docker run --rm --privileged \
          -v /tmp/earthly:/tmp/earthly \
          -v "$PWD:/earthly" \
          -w /earthly \
          earthly/earth:"EARTHLY_VERSION" -p +test
      - save_cache:
          key: earthly-buildkit-{{ epoch }}
          paths:
              - /tmp/earthly
      # - restore_cache:
      #     keys:
      #       - earthly-
      # - run: ./.circleci/gh-dl-release.sh "$EARTHLY_VERSION" earth-linux-amd64
      # - run: sudo mv ./earth-linux-amd64 /usr/bin/earth
      # - run: sudo chmod +x /usr/bin/earth
      # - run: earth +all
      # - run: earth -p +test
      # - run: docker stop earthly-buildkitd
      # - save_cache:
      #     key: earthly-{{ epoch }}
      #     paths:
      #       - /tmp/earthly

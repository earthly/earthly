version: 2.1
jobs:
  build-linux:
    machine:
      image: ubuntu-1604:201903-01
      docker_layer_caching: true
    environment:
      - EARTHLY_VERSION: "v0.0.1"
      - EARTHLY_EARTH_IMAGE: "earthly/earth:v0.0.1"
      - EARTHLY_BUILDKITD_IMAGE: "earthly/buildkitd:v0.0.1"
    steps:
      - checkout
      - restore_cache:
          keys:
            - earthly-buildkit-
      - run: docker pull "$EARTHLY_EARTH_IMAGE"
      - run: |
          docker run --rm --privileged \
            -v /tmp/earthly:/tmp/earthly \
            -v "$PWD:/earthly" \
            -v "/var/run/docker.sock:/var/run/docker.sock" \
            -w /earthly \
            --entrypoint=/usr/bin/earth-buildkitd-wrapper.sh \
            "$EARTHLY_EARTH_IMAGE" +base
      - run: sudo chown -R "circleci:circleci" /tmp/earthly
      - save_cache:
          key: earthly-buildkit-{{ epoch }}
          paths:
              - /tmp/earthly
  build-darwin:
    macos:
      xcode: 11.3.1
    environment:
      - EARTHLY_VERSION: "v0.0.1"
      - EARTHLY_BUILDKITD_IMAGE: "earthly/buildkitd:v0.0.1"
      - HOMEBREW_NO_AUTO_UPDATE: 1
    steps:
      - run: brew cask install docker
      - run: sleep 5
      - run: ln -s /Applications/Docker.app/Contents/Resources/bin /usr/local/bin/docker
      - run: docker run hello-world
      - run: ./.circleci/gh-dl-release.sh "$EARTHLY_VERSION" earth-linux-amd64
      - run: mv ./earth-darwin-amd64 ./earth
      - run: chmod +x ./earth
      - checkout
      - run: ./earth +base
      - run: docker stop earthly-buildkitd

workflows:
  build-all:
    jobs:
      - build-linux
      - build-darwin

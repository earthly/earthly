VERSION 0.6

FROM alpine:3.13
CACHE /base/persistent

test-prev-prev:
    WORKDIR /test
    CACHE ./my/data
    RUN echo "hello" >> ./my/data/hello
    RUN echo "hello" >> /base/persistent/hello

test-prev:
    FROM +test-prev-prev
    CACHE ./my/other
    RUN echo "hello again" >> ./my/other/hello
    RUN cat ./my/data/hello
    RUN echo "$(cat ./my/data/hello) world" > ./my/data/hello
    RUN echo "$(cat /base/persistent/hello), hello" > /base/persistent/hello

test:
    FROM +test-prev
    RUN cat ./my/data/hello
    # Persistent cache from previous targets should be accessible.
    RUN test "$(cat ./my/data/hello)" = "hello world"
    RUN test "$(cat ./my/other/hello)" = "hello again"
    # The persistent cache from the +base target should be accessible.
    RUN test "$(cat /base/persistent/hello)" = "hello, hello"
    # The temporary backup directory should have been removed.
    RUN test -d /earthly-tmp-a8cb9b0e-f285-4851-b00e-cd5b1ac6a499; test $? = 1

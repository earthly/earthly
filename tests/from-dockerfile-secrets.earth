VERSION 0.6

test:
    FROM DOCKERFILE --secret TEST_SECRET_2 --secret TEST_SECRET_1=+secrets/SUPER_SECRET +create-dockerfile/
    RUN test "$(cat /TEST_ENV_SECRET_1.txt)" = "foosecret"
    RUN test "$(cat /TEST_ENV_SECRET_2.txt)" = "this is secret from ENV"

create-dockerfile:
        FROM alpine:3.15
        RUN mkdir dist
        RUN echo "
FROM busybox:latest

RUN --mount=type=secret,id=TEST_SECRET_1,target=/mount.txt cp /mount.txt /TEST_ENV_SECRET_1.txt
RUN --mount=type=secret,id=TEST_SECRET_2,target=/mount.txt cp /mount.txt /TEST_ENV_SECRET_2.txt

" > dist/Dockerfile
    RUN cat dist/Dockerfile
    SAVE ARTIFACT dist/*

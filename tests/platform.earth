VERSION --new-platform 0.6

FROM alpine:3.15

all:
    # Regular ones.
    BUILD --platform=linux/amd64 --platform=linux/arm64 --platform=linux/arm/v7 +test
    BUILD --platform=native +test --name=native
    BUILD --platform=user +test --name=user
    BUILD +test --name=default

    # Start as one platform and end up as another.
    BUILD --platform=linux/amd64 +test --override_platform=linux/arm64 --name=override/linux/arm64
    BUILD --platform=linux/arm64 +test --override_platform=linux/amd64 --name=override/linux/amd64
    BUILD +test --override_platform=linux/arm64 --name=default_override/linux/arm64
    BUILD +test --override_platform=linux/amd64 --name=default_override/linux/amd64

    # Copy tests.
    BUILD +test-copy --copy_platform=linux/amd64 --copy_platform=linux/arm64
    BUILD --platform=linux/amd64 +test-copy --copy_platform=linux/arm64 --name=copy_other_set/linux/arm64
    BUILD --platform=linux/arm64 +test-copy --copy_platform=linux/amd64 --name=copy_other_set/linux/amd64
    BUILD +test-copy --copy_platform=linux/arm64 --copy_override_platform=linux/amd64 --name=copy_override/linux/amd64
    BUILD +test-copy --copy_platform=linux/amd64 --copy_override_platform=linux/arm64 --name=copy_override/linux/arm64
    BUILD +test-copy --copy_platform=linux/arm64 --copy_override_platform=native --name=copy_native1
    BUILD +test-copy --copy_platform=linux/amd64 --copy_override_platform=native --name=copy_native2

test:
    ARG override_platform
    IF [ -n "$override_platform" ]
        FROM --platform=$override_platform alpine:3.15
    ELSE
        FROM alpine:3.15
    END
    WORKDIR /work
    ARG USERPLATFORM
    ARG NATIVEPLATFORM
    ARG TARGETPLATFORM
    ARG name=regular/$TARGETPLATFORM
    RUN uname -m >./uname-m
    RUN echo "$USERPLATFORM" >./userplatform
    RUN echo "$NATIVEPLATFORM" >./nativeplatform
    RUN echo "$TARGETPLATFORM" >./platform
    SAVE ARTIFACT ./* AS LOCAL ./out/$name/

test-copy:
    FROM alpine:3.15
    WORKDIR /work
    ARG copy_platform
    IF [ -n "$copy_platform" ]
        COPY --platform=$copy_platform +copy-target/* ./
    ELSE
        COPY +copy-target/* ./
    END
    ARG name=copy/$copy_platform
    SAVE ARTIFACT ./* AS LOCAL ./out/$name/

copy-target:
    ARG copy_override_platform
    IF [ -n "$copy_override_platform" ]
        FROM --platform=$copy_override_platform alpine:3.15
    ELSE
        FROM alpine:3.15
    END
    WORKDIR /work
    ARG USERPLATFORM
    ARG NATIVEPLATFORM
    ARG TARGETPLATFORM
    ARG name=$TARGETPLATFORM
    RUN uname -m >./uname-m
    RUN echo "$USERPLATFORM" >./userplatform
    RUN echo "$NATIVEPLATFORM" >./nativeplatform
    RUN echo "$TARGETPLATFORM" >./platform
    SAVE ARTIFACT ./*
